<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conector de Teste da API</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 20px; background-color: #f4f4f4; }
        h1 { text-align: center; }
        h2 { border-bottom: 2px solid #007bff; padding-bottom: 5px; color: #333; }
        .container { max-width: 900px; margin: 0 auto; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        fieldset { background-color: #fdfdfd; border: 1px solid #ccc; border-radius: 5px; margin-bottom: 20px; padding: 15px; }
        legend { font-weight: bold; font-size: 1.1em; padding: 0 5px; }
        label { display: block; margin-bottom: 5px; font-weight: 500; }
        input[type="text"], input[type="password"], input[type="number"] { width: calc(100% - 20px); padding: 8px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; }
        button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; transition: background-color 0.2s; }
        button:hover { background-color: #0056b3; }
        #response-container { margin-top: 20px; }
        h3 { margin-bottom: 5px; }
        pre { background-color: #272822; color: #f8f8f2; padding: 15px; border-radius: 5px; overflow-x: auto; font-family: "Courier New", Courier, monospace; }
        .token-display { font-size: 0.9em; color: #006400; font-weight: bold; word-break: break-all; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Conector de Teste da API</h1>
        
        <fieldset>
            <legend>Configuração</legend>
            <label for="base-url">URL Base da API:</label>
            <input type="text" id="base-url" value="http://35.215.200.230:9090">
            <p class="token-display">Token JWT: <span id="jwt-token">Nenhum</span></p>
        </fieldset>

        <fieldset>
            <legend>1. Ping (GET /)</legend>
            <button id="btn-ping">Testar Conexão</button>
        </fieldset>

        <fieldset>
            <legend>2. Criar Usuário (POST /usuarios)</legend>
            <label for="create-user">Apelido:</label>
            <input type="text" id="create-user" value="usuario_teste">
            <label for="create-pass">Senha:</label>
            <input type="password" id="create-pass" value="senha123">
            <button id="btn-create-user">Criar Usuário</button>
        </fieldset>

        <fieldset>
            <legend>3. Obter Token (POST /token)</legend>
            <label for="login-user">Username (Apelido):</label>
            <input type="text" id="login-user" value="usuario_teste">
            <label for="login-pass">Password:</label>
            <input type="password" id="login-pass" value="senha123">
            <button id="btn-login">Login (Obter Token)</button>
        </fieldset>

        <fieldset>
            <legend>4. Obter Categorias (GET /categorias)</legend>
            <button id="btn-get-categories">Buscar Categorias</button>
        </fieldset>

        <fieldset>
            <legend>5. Criar Post (POST /posts) (Requer Token)</legend>
            <label for="post-title">Título:</label>
            <input type="text" id="post-title" value="Meu Post de Teste">
            <label for="post-content">Conteúdo:</label>
            <input type="text" id="post-content" value="Este é o conteúdo do post.">
            <label for="post-category">Categoria ID:</label>
            <input type="number" id="post-category" value="1">
            <button id="btn-create-post">Criar Post</button>
        </fieldset>

        <div id="response-container">
            <h3>Resposta da API:</h3>
            <pre id="response-output">{ "mensagem": "Aguardando requisição..." }</pre>
        </div>
    </div>

    <script>
        const output = document.getElementById('response-output');
        const tokenDisplay = document.getElementById('jwt-token');
        let apiToken = null;

        // --- Helper Functions ---
        
        function getBaseUrl() {
            return document.getElementById('base-url').value;
        }

        async function handleFetch(url, options) {
            try {
                const response = await fetch(url, options);
                const data = await response.json();

                if (!response.ok) {
                    throw { status: response.status, body: data };
                }
                
                showResponse(data);
                return data; // Retorna os dados em caso de sucesso

            } catch (error) {
                console.error('Fetch Error:', error);
                showError(error);
            }
        }

        function showResponse(data) {
            output.textContent = JSON.stringify(data, null, 2);
            output.style.color = "#f8f8f2"; // Cor padrão
        }

        function showError(error) {
            const errorMsg = {
                message: "Erro na requisição.",
                status: error.status || "Fetch failed",
                body: error.body || { detail: "Verifique o console do navegador ou se a API está no ar." }
            };
            output.textContent = JSON.stringify(errorMsg, null, 2);
            output.style.color = "#f92672"; // Cor de erro
        }

        // --- 1. Ping ---
        document.getElementById('btn-ping').addEventListener('click', () => {
            const url = getBaseUrl() + '/';
            handleFetch(url, { method: 'GET' });
        });

        // --- 2. Criar Usuário ---
        document.getElementById('btn-create-user').addEventListener('click', () => {
            const url = getBaseUrl() + '/usuarios';
            const user = document.getElementById('create-user').value;
            const pass = document.getElementById('create-pass').value;

            handleFetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ apelido: user, senha: pass })
            });
        });

        // --- 3. Login / Obter Token ---
        document.getElementById('btn-login').addEventListener('click', async () => {
            const url = getBaseUrl() + '/token';
            const user = document.getElementById('login-user').value;
            const pass = document.getElementById('login-pass').value;

            const body = new URLSearchParams();
            body.append('username', user);
            body.append('password', pass);

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: body
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw { status: response.status, body: data };
                }
console.log(data);

                // Sucesso
                apiToken = data.access_token; // Baseado no helpers.api_response(j)
                tokenDisplay.textContent = `Bearer ${apiToken.substring(0, 30)}...`;
                showResponse(data);

            } catch (error) {
                console.error('Login Error:', error);
                apiToken = null;
                tokenDisplay.textContent = "Falha no login";
                showError(error);
            }
        });

        // --- 4. Obter Categorias ---
        document.getElementById('btn-get-categories').addEventListener('click', () => {
            // O README indica 'body' para paginação, mas o app.py usa Paging
            // que em FastAPI GET é tipicamente query string.
            const url = getBaseUrl() + '/categorias?page=1&page_size=5';
            handleFetch(url, { method: 'GET' });
        });

        // --- 5. Criar Post (Autenticado) ---
        document.getElementById('btn-create-post').addEventListener('click', () => {
            if (!apiToken) {
                showError({ body: { detail: "Você precisa obter um token primeiro (Seção 3)." } });
                return;
            }

            const url = getBaseUrl() + '/posts';
            const title = document.getElementById('post-title').value;
            const content = document.getElementById('post-content').value;
            const categoryId = parseInt(document.getElementById('post-category').value, 10);

            handleFetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiToken}`
                },
                body: JSON.stringify({
                    titulo: title,
                    conteudo: content,
                    categoria_id: categoryId
                })
            });
        });

    </script>
</body>
</html>